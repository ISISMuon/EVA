import pytest
from pytestqt.plugin import qapp
from EVA.core.data_searching import getmatch
from EVA.core.app import get_app

# TODO: add more test parameters
# MUON DATABASE TEST PARAMETERS ###################################

default_peaks_list_mudirac = [
    [330.9, 296.5, 92.6, 1253.7, 330.7]
]

default_sigma_list_mudirac = [0.45]

target_result_list_mudirac = [
    [[{'element': '65Cu', 'energy': 330.8759462590539, 'error': 0.45, 'peak_centre': 330.9, 'transition': '3d5/2-2p3/2', 'diff': 0.024053740946101243}, {'element': '63Cu', 'energy': 330.8637696226564, 'error': 0.45, 'peak_centre': 330.9, 'transition': '3d5/2-2p3/2', 'diff': 0.036230377343599685}, {'element': '54Fe', 'energy': 92.68149464849199, 'error': 0.45, 'peak_centre': 92.6, 'transition': '4f7/2-3d5/2', 'diff':0.08149464849199717}, {'element': '124Sn', 'energy': 330.6156042247209, 'error': 0.45, 'peak_centre': 330.7, 'transition': '8g9/2-4f7/2', 'diff': 0.08439577527906295}, {'element': '24Mg', 'energy': 296.5883009888491, 'error': 0.45, 'peak_centre': 296.5, 'transition': '2p3/2-1s1/2', 'diff': 0.08830098884908466}, {'element': '25Mg', 'energy': 296.588338828472, 'error': 0.45, 'peak_centre': 296.5, 'transition': '2p1/2-1s1/2', 'diff': 0.08833882847198993}, {'element': '56Fe', 'energy': 92.6884737419248, 'error': 0.45, 'peak_centre': 92.6, 'transition': '4f7/2-3d5/2', 'diff': 0.08847374192480117}, {'element': '122Sn', 'energy': 330.6106014617376, 'error': 0.45, 'peak_centre': 330.7, 'transition': '8g9/2-4f7/2', 'diff': 0.08939853826240096}, {'element': '57Fe', 'energy': 92.69178655977211, 'error': 0.45, 'peak_centre': 92.6, 'transition': '4f7/2-3d5/2', 'diff': 0.09178655977211747}, {'element': '120Sn', 'energy': 330.60543267861925, 'error': 0.45, 'peak_centre': 330.7, 'transition': '8g9/2-4f7/2', 'diff': 0.09456732138073676}, {'element': '58Fe', 'energy': 92.6949800815429, 'error': 0.45, 'peak_centre': 92.6, 'transition': '4f7/2-3d5/2', 'diff': 0.09498008154290005}, {'element': '118Sn', 'energy': 330.6000879320787, 'error': 0.45, 'peak_centre': 330.7, 'transition': '8g9/2-4f7/2', 'diff': 0.09991206792130924}, {'element': '117Sn', 'energy': 330.5973489870325, 'error': 0.45, 'peak_centre': 330.7, 'transition': '8g9/2-4f7/2', 'diff': 0.1026510129674989}, {'element': '116Sn', 'energy': 330.5945598693603, 'error': 0.45, 'peak_centre': 330.7, 'transition': '8g9/2-4f7/2', 'diff': 0.1054401306396926}, {'element': '24Mg', 'energy': 296.39410739301, 'error': 0.45, 'peak_centre': 296.5, 'transition': '2p1/2-1s1/2', 'diff': 0.1058926069899826}, {'element': '115Sn', 'energy': 330.5917236051052, 'error': 0.45, 'peak_centre': 330.7, 'transition': '8g9/2-4f7/2', 'diff': 0.10827639489480134}, {'element': '114Sn', 'energy': 330.58884041269476, 'error': 0.45, 'peak_centre': 330.7, 'transition': '8g9/2-4f7/2', 'diff': 0.1111595873052238}, {'element': '26Mg', 'energy':296.6112804773604, 'error': 0.45, 'peak_centre': 296.5, 'transition': '2p1/2-1s1/2', 'diff': 0.1112804773604239}, {'element': '112Sn', 'energy': 330.5829197094713, 'error': 0.45, 'peak_centre': 330.7, 'transition': '8g9/2-4f7/2', 'diff': 0.11708029052869051}, {'element': '63Cu', 'energy': 330.8637696226564, 'error': 0.45, 'peak_centre': 330.7, 'transition': '3d5/2-2p3/2', 'diff': 0.16376962265638895}, {'element': '58Ni', 'energy': 92.7705632278572, 'error': 0.45, 'peak_centre': 92.6, 'transition': '7g9/2-4f7/2', 'diff': 0.17056322785720113}, {'element': '65Cu', 'energy': 330.8759462590539, 'error': 0.45, 'peak_centre': 330.7, 'transition': '3d5/2-2p3/2', 'diff': 0.1759462590538874}, {'element': '60Ni', 'energy': 92.77663652047369, 'error': 0.45, 'peak_centre': 92.6, 'transition': '7g9/2-4f7/2', 'diff': 0.17663652047369283}, {'element': '61Ni', 'energy': 92.779529048836, 'error': 0.45, 'peak_centre': 92.6, 'transition': '7g9/2-4f7/2', 'diff': 0.1795290488360024}, {'element': '62Ni', 'energy': 92.7823227775648, 'error': 0.45,'peak_centre': 92.6, 'transition': '7g9/2-4f7/2', 'diff': 0.18232277756480642}, {'element': '64Ni', 'energy': 92.7876560896612, 'error': 0.45, 'peak_centre': 92.6, 'transition': '7g9/2-4f7/2', 'diff': 0.1876560896612034}, {'element': '24Mg', 'energy': 92.7903088348456, 'error': 0.45, 'peak_centre': 92.6, 'transition': '7d5/2-2p3/2', 'diff': 0.19030883484560945}, {'element': '25Mg', 'energy': 92.8078722891227, 'error': 0.45, 'peak_centre': 92.6, 'transition': '7d5/2-2p3/2', 'diff': 0.2078722891227045}, {'element': '26Mg', 'energy': 92.82401042551741, 'error': 0.45, 'peak_centre': 92.6, 'transition': '7d5/2-2p3/2', 'diff': 0.22401042551742023}, {'element': '55Mn', 'energy': 331.1410402981839, 'error': 0.45, 'peak_centre': 330.9, 'transition': '4d5/2-2p3/2', 'diff': 0.24104029818391837}, {'element': '25Mg', 'energy': 296.7826027887621, 'error': 0.45, 'peak_centre': 296.5, 'transition': '2p3/2-1s1/2', 'diff': 0.2826027887621194}, {'element': '124Sn', 'energy': 330.6156042247209, 'error': 0.45, 'peak_centre': 330.9, 'transition': '8g9/2-4f7/2', 'diff': 0.2843957752790516}, {'element': '122Sn', 'energy': 330.6106014617376, 'error': 0.45, 'peak_centre': 330.9, 'transition': '8g9/2-4f7/2', 'diff': 0.2893985382623896}, {'element': '120Sn', 'energy': 330.60543267861925, 'error': 0.45, 'peak_centre': 330.9, 'transition': '8g9/2-4f7/2', 'diff': 0.2945673213807254}, {'element': '118Sn', 'energy': 330.6000879320787, 'error': 0.45, 'peak_centre':330.9, 'transition': '8g9/2-4f7/2', 'diff': 0.2999120679212979}, {'element': '117Sn', 'energy': 330.5973489870325, 'error': 0.45, 'peak_centre': 330.9, 'transition': '8g9/2-4f7/2', 'diff': 0.30265101296748753}, {'element': '116Sn', 'energy': 330.5945598693603, 'error': 0.45, 'peak_centre': 330.9, 'transition': '8g9/2-4f7/2', 'diff': 0.30544013063968123}, {'element': '26Mg', 'energy': 296.8055713668884, 'error': 0.45, 'peak_centre': 296.5, 'transition': '2p3/2-1s1/2', 'diff': 0.3055713668883868}, {'element': '115Sn', 'energy': 330.5917236051052, 'error': 0.45, 'peak_centre': 330.9, 'transition': '8g9/2-4f7/2', 'diff': 0.30827639489479}, {'element': '114Sn', 'energy': 330.58884041269476, 'error': 0.45, 'peak_centre': 330.9, 'transition': '8g9/2-4f7/2', 'diff': 0.3111595873052124}, {'element': '112Sn', 'energy': 330.5829197094713, 'error': 0.45, 'peak_centre': 330.9, 'transition': '8g9/2-4f7/2', 'diff': 0.31708029052867914}, {'element': '142Ce', 'energy': 330.3704757411484, 'error': 0.45, 'peak_centre': 330.7, 'transition': '6g9/2-4f7/2', 'diff': 0.32952425885156345}, {'element': '140Ce', 'energy': 330.3666338644002, 'error': 0.45, 'peak_centre': 330.7, 'transition': '6g9/2-4f7/2', 'diff': 0.3333661355997606}, {'element': '138Ce', 'energy': 330.3627340604255, 'error': 0.45, 'peak_centre': 330.7, 'transition': '6g9/2-4f7/2', 'diff': 0.33726593957447903}, {'element': '136Ce', 'energy': 330.35872728727014, 'error': 0.45, 'peak_centre': 330.7, 'transition': '6g9/2-4f7/2', 'diff': 0.3412727127298467}, {'element': '133Cs', 'energy': 296.92093063922766, 'error': 0.45, 'peak_centre': 296.5, 'transition': '6g9/2-4f7/2', 'diff': 0.42093063922766305}, {'element': '55Mn', 'energy': 331.1410402981839, 'error': 0.45, 'peak_centre': 330.7, 'transition': '4d5/2-2p3/2', 'diff': 0.441040298183907}, {'element': '112Sn', 'energy': 296.9953270791616, 'error': 0.9, 'peak_centre': 296.5, 'transition': '7g9/2-4f7/2', 'diff': 0.4953270791615978}, {'element': '114Sn', 'energy': 297.0006434405585, 'error': 0.9, 'peak_centre': 296.5, 'transition': '7g9/2-4f7/2', 'diff': 0.5006434405585196}, {'element': '115Sn', 'energy': 297.0032332468191, 'error': 0.9, 'peak_centre': 296.5, 'transition': '7g9/2-4f7/2', 'diff': 0.503233246819093}, {'element': '116Sn', 'energy': 297.00577977829766, 'error': 0.9, 'peak_centre': 296.5, 'transition': '7g9/2-4f7/2', 'diff': 0.505779778297665}, {'element': '117Sn', 'energy': 297.00828373049603, 'error': 0.9, 'peak_centre': 296.5, 'transition': '7g9/2-4f7/2', 'diff': 0.5082837304960321}, {'element': '118Sn', 'energy': 297.0107443029687, 'error': 0.9, 'peak_centre': 296.5, 'transition': '7g9/2-4f7/2', 'diff': 0.5107443029687033}, {'element': '120Sn', 'energy':297.0155431441554, 'error': 0.9, 'peak_centre': 296.5, 'transition': '7g9/2-4f7/2', 'diff': 0.5155431441554015}, {'element': '122Sn', 'energy': 297.0201851795145, 'error': 0.9, 'peak_centre': 296.5, 'transition': '7g9/2-4f7/2', 'diff': 0.5201851795144989}, {'element': '124Sn', 'energy': 297.0246772905315, 'error': 0.9, 'peak_centre': 296.5, 'transition': '7g9/2-4f7/2', 'diff': 0.5246772905314856}, {'element': '142Ce', 'energy': 330.3704757411484, 'error': 0.9, 'peak_centre': 330.9, 'transition': '6g9/2-4f7/2', 'diff': 0.5295242588515521}, {'element': '140Ce', 'energy': 330.3666338644002, 'error': 0.9, 'peak_centre':330.9, 'transition': '6g9/2-4f7/2', 'diff': 0.5333661355997492}, {'element': '138Ce', 'energy': 330.3627340604255, 'error': 0.9, 'peak_centre': 330.9, 'transition': '6g9/2-4f7/2', 'diff': 0.5372659395744677}, {'element': '136Ce', 'energy': 330.35872728727014, 'error': 0.9, 'peak_centre': 330.9, 'transition': '6g9/2-4f7/2', 'diff': 0.5412727127298353}, {'element': '113In', 'energy': 331.46646853000965, 'error': 0.9, 'peak_centre': 330.9, 'transition': '4f7/2-3d5/2', 'diff': 0.5664685300096721}, {'element': '115In', 'energy': 331.4720795622729, 'error': 0.9, 'peak_centre': 330.9, 'transition': '4f7/2-3d5/2', 'diff': 0.5720795622729042}, {'element': '41K', 'energy': 92.00416903236528, 'error': 0.9, 'peak_centre': 92.6, 'transition': '7f7/2-3d5/2', 'diff': 0.5958309676347113}, {'element': '40K', 'energy': 91.9977986879728, 'error': 0.9, 'peak_centre': 92.6, 'transition': '7f7/2-3d5/2', 'diff': 0.6022013120271907}, {'element': '39K', 'energy': 91.9910906485446, 'error': 0.9, 'peak_centre': 92.6, 'transition': '7f7/2-3d5/2', 'diff': 0.6089093514553952}, {'element': '174Hf', 'energy': 1254.3117883402583, 'error': 0.9, 'peak_centre': 1253.7, 'transition': '6f5/2-3d3/2', 'diff': 0.611788340258272}, {'element': '180Hf', 'energy': 1254.3131467442968, 'error': 0.9, 'peak_centre': 1253.7, 'transition': '6f5/2-3d3/2', 'diff': 0.6131467442967278}, {'element': '58Fe', 'energy': 1254.3572082009755, 'error': 0.9, 'peak_centre': 1253.7, 'transition':'2p3/2-1s1/2', 'diff': 0.6572082009754467}, {'element': '82Se', 'energy': 295.82479742708307, 'error': 0.9, 'peak_centre': 296.5, 'transition': '7f7/2-3d5/2', 'diff': 0.6752025729169304}, {'element': '80Se', 'energy': 295.8145246802654, 'error': 0.9, 'peak_centre': 296.5, 'transition': '7f7/2-3d5/2', 'diff': 0.6854753197346213}, {'element': '120Te', 'energy': 93.29554329423519, 'error': 0.9, 'peak_centre': 92.6, 'transition': '6h11/2-5g9/2', 'diff': 0.6955432942351933}, {'element': '78Se', 'energy': 295.8037312557931, 'error': 0.9, 'peak_centre': 296.5, 'transition': '7f7/2-3d5/2', 'diff': 0.6962687442069182}, {'element': '122Te', 'energy': 93.29699659937, 'error': 0.9, 'peak_centre': 92.6, 'transition': '6h11/2-5g9/2', 'diff': 0.69699659937001}, {'element': '124Te', 'energy': 93.2984047318298, 'error': 0.9, 'peak_centre': 92.6, 'transition': '6h11/2-5g9/2', 'diff': 0.698404731829811}, {'element': '125Te', 'energy': 93.2990923664331, 'error': 0.9, 'peak_centre': 92.6, 'transition': '6h11/2-5g9/2', 'diff': 0.6990923664331063}, {'element': '126Te', 'energy': 93.29976875735869, 'error': 0.9, 'peak_centre': 92.6, 'transition': '6h11/2-5g9/2', 'diff': 0.6997687573586973}, {'element': '128Te', 'energy': 93.3010904760908, 'error': 0.9, 'peak_centre': 92.6, 'transition': '6h11/2-5g9/2', 'diff': 0.7010904760908119}, {'element': '77Se', 'energy': 295.79813552217206, 'error': 0.9, 'peak_centre': 296.5, 'transition': '7f7/2-3d5/2', 'diff': 0.7018644778279395}, {'element': '130Te', 'energy': 93.3023718532668, 'error': 0.9, 'peak_centre': 92.6, 'transition': '6h11/2-5g9/2', 'diff': 0.7023718532668113}, {'element': '76Se', 'energy': 295.7923749070707, 'error': 0.9, 'peak_centre': 296.5, 'transition': '7f7/2-3d5/2', 'diff': 0.7076250929292769}, {'element': '74Se', 'energy': 295.78034669614124, 'error': 0.9, 'peak_centre': 296.5, 'transition': '7f7/2-3d5/2', 'diff': 0.7196533038587631}, {'element': '113In', 'energy': 331.46646853000965, 'error': 0.9, 'peak_centre': 330.7, 'transition': '4f7/2-3d5/2', 'diff': 0.7664685300096608}, {'element': '115In', 'energy': 331.4720795622729, 'error': 0.9, 'peak_centre': 330.7, 'transition': '4f7/2-3d5/2', 'diff': 0.7720795622728929}, {'element': '174Hf', 'energy': 331.6954696931079, 'error': 0.9, 'peak_centre': 330.9, 'transition': '5g9/2-4f7/2', 'diff': 0.7954696931079184}, {'element': '180Hf', 'energy': 331.70275579195624, 'error': 0.9, 'peak_centre': 330.9, 'transition': '5g9/2-4f7/2', 'diff': 0.8027557919562582}, {'element': '51V', 'energy': 331.7546153433915, 'error': 0.9, 'peak_centre': 330.9, 'transition': '6d5/2-2p3/2', 'diff': 0.8546153433915151}]]
]

default_peaks_list_legacy = [
    [330.9, 296.5, 92.6, 1253.7, 330.7]
]

default_sigma_list_legacy = [0.45]

target_result_list_legacy = [
    [[{'element': 'Cu', 'energy': 330.9, 'error': 0, 'peak_centre': 330.9, 'transition': 'L(3d->2p)', 'diff': 0}, {'element': 'Mg', 'energy': 296.5, 'error': 0, 'peak_centre': 296.5, 'transition': 'K(2p->1s)', 'diff': 0}, {'element': 'Fe', 'energy': 92.6, 'error': 0, 'peak_centre': 92.6, 'transition': 'M(4f->3d)', 'diff': 0}, {'element': 'Fe', 'energy': 1253.7, 'error': 0, 'peak_centre': 1253.7, 'transition': 'K(2p1/2->1s1/2)', 'diff': 0}, {'element': 'Se', 'energy': 296.3, 'error': 0.45, 'peak_centre': 296.5, 'transition': 'M(7f->3d)', 'diff': 0.19999999999998863}, {'element': 'Cu', 'energy': 330.9, 'error': 0.45, 'peak_centre': 330.7, 'transition': 'L(3d->2p)', 'diff': 0.19999999999998863}, {'element': 'Mn', 'energy': 331.2, 'error': 0.45, 'peak_centre': 330.9, 'transition': 'L(4d->2p)', 'diff': 0.30000000000001137}, {'element': 'Sn', 'energy': 331.2, 'error': 0.45, 'peak_centre': 330.9, 'transition': 'N(8g->4f)', 'diff': 0.30000000000001137}, {'element': 'Mg', 'energy': 93.0, 'error': 0.45, 'peak_centre': 92.6, 'transition': 'L(7d->2p)', 'diff': 0.4000000000000057}, {'element': 'In', 'energy': 331.3, 'error': 0.45, 'peak_centre': 330.9, 'transition': 'M(4f->3d)', 'diff': 0.4000000000000341}, {'element': 'Ni', 'energy': 93.1, 'error': 0.9, 'peak_centre': 92.6, 'transition': 'N(7g->4f)', 'diff': 0.5}, {'element': 'Mn', 'energy': 331.2, 'error': 0.9, 'peak_centre': 330.7, 'transition': 'L(4d->2p)', 'diff': 0.5}, {'element': 'Sn', 'energy': 331.2, 'error': 0.9, 'peak_centre': 330.7, 'transition': 'N(8g->4f)', 'diff': 0.5}, {'element': 'Ce', 'energy': 331.5, 'error': 0.9, 'peak_centre': 330.9, 'transition': 'N(6g->4f)', 'diff': 0.6000000000000227}, {'element': 'In', 'energy': 331.3, 'error': 0.9, 'peak_centre': 330.7, 'transition': 'M(4f->3d)', 'diff': 0.6000000000000227}, {'element': 'Er', 'energy': 295.8, 'error': 0.9, 'peak_centre': 296.5, 'transition': 'N(5g->4f)', 'diff': 0.6999999999999886}, {'element': 'Na', 'energy': 297.2, 'error': 0.9, 'peak_centre': 296.5, 'transition': 'K(3p->1s)', 'diff': 0.6999999999999886}, {'element': 'Ta', 'energy': 295.8, 'error': 0.9, 'peak_centre': 296.5, 'transition': 'O(7h->5g)', 'diff': 0.6999999999999886}, {'element': 'K', 'energy': 93.3, 'error': 0.9, 'peak_centre': 92.6, 'transition': 'M(7f->3d)', 'diff': 0.7000000000000028}, {'element': 'Hf', 'energy': 331.6, 'error': 0.9, 'peak_centre': 330.9, 'transition': 'N(5g->4f)', 'diff': 0.7000000000000455}, {'element': 'V', 'energy': 331.6, 'error': 0.9, 'peak_centre': 330.9, 'transition': 'L(6d->2p)', 'diff': 0.7000000000000455}, {'element': 'Ce', 'energy': 331.5, 'error': 0.9, 'peak_centre': 330.7, 'transition': 'N(6g->4f)', 'diff': 0.8000000000000114}]]
]


# GAMMA DATABASE TEST PARAMETERS #################################

default_peaks_list_gamma = [
    [20.500]
]

default_sigma_list_gamma = [0.01]

target_result_list_gamma = [
    [{'Element': '140Eu', 'Energy': 20.5, 'diff': 0.0, 'Intensity': ' 0.000E+00', 'lifetime': '        '}]
]

#################################################################

class TestDatabasesGetMatch:
    # Parametrised test to check if database searches from legacy database matches expected results.
    @pytest.mark.parametrize("default_peaks, default_sigma, target_result",
                             list(zip(default_peaks_list_legacy, default_sigma_list_legacy, target_result_list_legacy)))
    def test_muon_legacy_db_match(self, qapp, default_peaks, default_sigma, target_result):
        # Switch to legacy db
        app = get_app()
        app.use_legacy_muon_db()

        # Generate input string to test matches
        input_data = list(zip(default_peaks, [default_sigma] * len(default_peaks)))

        res, res1, res2 = getmatch.get_matches(input_data)
        assert res == target_result, 'Data in legacy muon database did not match expected'

    # Parameterised test to check if database searches from mudirac database matches expected results.
    @pytest.mark.parametrize("default_peaks, default_sigma, target_result",
                             list(zip(default_peaks_list_mudirac, default_sigma_list_mudirac, target_result_list_mudirac)))
    def test_muon_mudirac_db_match(self, qapp, default_peaks, default_sigma, target_result):
        # Switch to mudirac db
        app = get_app()
        app.use_mudirac_muon_db()

        # Generate input string to test matches
        input_data = list(zip(default_peaks, [default_sigma] * len(default_peaks)))

        res, res1, res2 = getmatch.get_matches(input_data)
        print(res)
        assert res == target_result, 'Data in mudirac muon database did not match expected'


    # Parameterised test to check if database searches from gamma database matches expected results.
    @pytest.mark.parametrize("default_peaks, default_sigma, target_result",
                             list(zip(default_peaks_list_gamma, default_sigma_list_gamma, target_result_list_gamma)))
    def test_gamma_match(self, qapp, default_peaks, default_sigma, target_result):
        # Generate input string to test matches
        input_data = list(zip(default_peaks, [default_sigma] * len(default_peaks)))
        res = getmatch.getmatchesgammas(input_data)

        assert res == target_result, 'Data in gamma database did not match expected'